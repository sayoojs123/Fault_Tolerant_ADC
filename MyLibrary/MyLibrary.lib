
* Ideal comparator
.subckt comparator in+ in- out
E1 out 0 Value = {if(V(in+, in-)>0, {Vhigh}, {Vlow})}
Rin+ in+ 0 10Meg
Rin- in- 0 10Meg
.ends comparator



* 8-to-3 Priority Encoder for 1V/0V inputs from comparators
.subckt priority_encoder in7 in6 in5 in4 in3 in2 in1 in0 out2 out1 out0

* Output logic levels (matching your 1V inputs)
.param Vhigh=1.0 Vlow=0

* PRIORITY ENCODER LOGIC:
* Using 0.5V threshold for 1V/0V inputs

* out2 (MSB) = 1 for inputs 4,5,6,7
Eout2 out2 0 VALUE = { 
+ IF(V(in7)>0.5, Vhigh, 
+ IF(V(in6)>0.5, Vhigh, 
+ IF(V(in5)>0.5, Vhigh, 
+ IF(V(in4)>0.5, Vhigh, Vlow)))) 
+ }

* out1 = 1 for inputs 2,3,6,7
Eout1 out1 0 VALUE = { 
+ IF(V(in7)>0.5, Vhigh, 
+ IF(V(in6)>0.5, Vhigh, 
+ IF(V(in5)>0.5, Vlow, 
+ IF(V(in4)>0.5, Vlow, 
+ IF(V(in3)>0.5, Vhigh, 
+ IF(V(in2)>0.5, Vhigh, Vlow)))))) 
+ }

* out0 = 1 for inputs 1,3,5,7
Eout0 out0 0 VALUE = { 
+ IF(V(in7)>0.5, Vhigh, 
+ IF(V(in6)>0.5, Vlow, 
+ IF(V(in5)>0.5, Vhigh, 
+ IF(V(in4)>0.5, Vlow, 
+ IF(V(in3)>0.5, Vhigh, 
+ IF(V(in2)>0.5, Vlow, 
+ IF(V(in1)>0.5, Vhigh, 
+ IF(V(in0)>0.5, Vlow, Vlow)))))))) 
+ }

* Input resistances
Rin7 in7 0 1Meg
Rin6 in6 0 1Meg
Rin5 in5 0 1Meg
Rin4 in4 0 1Meg
Rin3 in3 0 1Meg
Rin2 in2 0 1Meg
Rin1 in1 0 1Meg
Rin0 in0 0 1Meg

* Output resistances
Rout2 out2 0 1k
Rout1 out1 0 1k
Rout0 out0 0 1k

.ends priority_encoder



* Fault Detection and Protection Block for QSPICE
* Checks if input voltage is within safe range (7V-9V)
.subckt fault_gate vin vout_to_comparators error_flag

* Fault Detection Logic using B-source (QSPICE preferred)
Bfault_detect fault_detect 0 V = (V(vin) > 7) && (V(vin) < 9) ? 0 : 1

* Error Flag Output (1V when fault, 0V when normal)
Berror error_flag 0 V = V(fault_detect) > 0.5 ? 1 : 0

* Output to Comparators: Pass through when normal, 0V when fault
Bgate vout_to_comparators 0 V = V(fault_detect) > 0.5 ? 0 : V(vin)

* Small filtering and stability components
Rfilt fault_detect 0 1k
Cfilt fault_detect 0 1p

.ends fault_gate